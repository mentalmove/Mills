function Rules(m,a,b){var d={white:9,black:9};var l=[];var n=this;function o(q,p){var r,t,i,s;if(q%2){r=q%8;if(l[r]==p&&l[r+8]==p&&l[r+16]==p){return true}t=[(q-1),q,(q+1)];if(t[2]%8==0){t[2]-=8}if(l[t[0]]==p&&l[t[1]]==p&&l[t[2]]==p){return true}}else{i=Math.floor(q/8)*8;s=i+7;t=[(q-2),(q-1),q];while(t[0]<i){t[0]+=8}while(t[1]<i){t[1]+=8}if(l[t[0]]==p&&l[t[1]]==p&&l[t[2]]==p){return true}t=[q,(q+1),(q+2)];while(t[2]>s){t[2]-=8}while(t[1]>s){t[1]-=8}if(l[t[0]]==p&&l[t[1]]==p&&l[t[2]]==p){return true}}return false}function k(r){var p;var q=[];for(p=0;p<l.length;p++){if(l[p]!=-1){continue}if(r&&o(p,-1)){continue}q.push(p)}if(r&&!q.length){k(false);return}for(p=0;p<q.length;p++){a[q[p]].enable_remove()}m.en_dis_able_remove(true)}function j(){var p=0;var r=0;for(var q=0;q<l.length;q++){if(l[q]==1){p++}if(l[q]==-1){r++}}m.phase=["lost","lost"];if(p==3){m.phase[0]="jump"}if(r==3){m.phase[1]="jump"}if(p>3){m.phase[0]="move"}if(r>3){m.phase[1]="move"}if(m.phase[0]=="lost"){n.game_end("black");return}if(m.phase[1]=="lost"){n.game_end("white")}}function f(){var s={};var r=[];var p=[];var q;for(q=0;q<l.length;q++){if(l[q]==0){r.push(q);a[q].update_location();p.push(a[q].style.location)}}for(q=0;q<l.length;q++){if(l[q]!=1){continue}s[q]=r;a[q].update_location()}for(var t in s){a[parseInt(t)].enable_move(r,p)}}function h(){var x={};var r=0;var u,v,q,w,z,t,y,s;for(s=0;s<l.length;s++){if(l[s]!=1){continue}u=(s%8)?s-1:s+7;v=(s%8!=7)?s+1:s-7;q=-1;w=-1;if(s%2){if(s-8>=0){w=s-8}if(s+8<l.length){q=s+8}}t=[];if(!l[u]){t.push(u)}if(!l[v]){t.push(v)}if(q!=-1&&!l[q]){t.push(q)}if(w!=-1&&!l[w]){t.push(w)}if(t.length){x[s]=t;r++}}if(!r){n.game_end("black")}else{for(var p in x){a[parseInt(p)].update_location();t=[];y=[];for(s=0;s<x[p].length;s++){a[x[p][s]].update_location();t.push(a[x[p][s]].style.location);y.push(x[p][s])}a[parseInt(p)].enable_move(y,t)}}}this.game_end=function(i){m.game_end(i)};this.swap_pieces=function(s,p,r){m.status="wait";a[s].remove_piece();a[p].set_piece(r);l[s]=0;l[p]=(r=="white")?1:-1;if(r=="white"){for(var q=0;q<a.length;q++){if(a[q].piece){a[q].disable_move()}}if(o(p,1)){k(true)}else{g.search_move()}}else{if(o(p,-1)){g.remove_piece();setTimeout(c,1234)}else{c()}}};this.remove_piece=function(i,p){l[i]=0;a[i].remove_piece();if(p=="white"){if(m.phase=="begin"){m.enable_set()}m.status="human"}else{m.status="wait";if(m.phase=="begin"){setTimeout(g.search_move,666)}else{j();setTimeout(g.search_move,666)}}m.en_dis_able_remove(false)};function c(){j();if(m.phase[0]=="move"){h()}else{f()}}this.set_piece=function(p,q){if(l[p]){a[p].disable_set();return false}d[q]--;l[p]=(q=="white")?1:-1;if(q=="black"&&d[q]<=0&&m.phase=="begin"){m.phase="move"}var i;if(q=="black"){a[p].set_piece("black");i=o(p,-1);if(i){m.en_dis_able_remove(true);g.remove_piece();if(m.phase=="begin"){return true}}if(m.phase=="begin"){m.enable_set()}else{if(i){setTimeout(c,1234)}else{c()}}m.status="human";return true}m.status="wait";if(o(p,1)){k(true);return true}g.search_move();return true};for(var e=0;e<a.length;e++){l[e]=0}m.status="human";b();var g=new Delegate(this,l,d)};